<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Plumeria Restaurant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclure la bibliothèque QRCode.js pour générer les QR codes -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .font-display { font-family: 'Playfair Display', serif; }
        .font-body { font-family: 'Inter', sans-serif; }
        
        .category-entrees { background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%); }
        .category-plats { background: linear-gradient(135deg, #fecaca 0%, #ef4444 100%); }
        .category-plats-malagasy { background: linear-gradient(135deg, #d1e7d1 0%, #059669 100%); }
        .category-desserts { background: linear-gradient(135deg, #e0e7ff 0%, #8b5cf6 100%); }
        
        .item-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .item-card.selected {
            border-color: #059669;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.2);
            transform: translateY(-1px);
        }
        
        .add-on-chip {
            transition: all 0.2s ease;
        }
        
        .add-on-chip:hover {
            transform: scale(1.05);
        }
        
        .add-on-chip.selected {
            background-color: #059669;
            color: white;
            border-color: #059669;
        }
        
        .cart-item {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gray-50 font-body">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b relative">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex justify-center items-center flex-col">
                <h1 id="restaurant-name" class="font-display text-4xl font-bold text-gray-900 text-center"></h1>
                <p id="restaurant-slogan" class="text-center text-gray-600 mt-2 font-light"></p>
                <button id="lang-btn" onclick="toggleLanguage()" class="absolute top-4 right-4 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg shadow hover:bg-gray-300 transition-colors">EN</button>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Menu Section - Will be generated by JavaScript -->
                <div id="menu-container" class="lg:col-span-2"></div>

                <!-- Panier -->
                <aside class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6 sticky top-8">
                        <h3 id="cart-title" class="font-display text-xl font-semibold text-gray-900 mb-4"></h3>
                        
                        <div id="cart-items" class="space-y-3 mb-6">
                            <div id="cart-placeholder" class="text-gray-500 text-center py-8 italic">
                                Sélectionnez vos plats pour commencer
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center text-lg font-semibold">
                                <span id="total-text"></span>
                                <span id="total-price" class="text-green-600">0 Ar</span>
                            </div>
                        </div>
                        
                        <div id="cart-actions" class="mt-6 hidden">
                            <button id="order-btn" onclick="showOrderSummary()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors mb-3">
                            </button>
                            <button id="clear-cart-btn" onclick="clearCart()" class="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                            </button>
                        </div>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <!-- Modal Order Summary -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto">
            <div class="text-center">
                <h3 id="modal-title" class="font-display text-2xl font-semibold text-gray-900 mb-4"></h3>
                <p id="modal-message" class="text-gray-600 mb-6"></p>

                <!-- Table number selection -->
                <div id="table-select-container" class="mb-6 text-left">
                    <label for="table-number" id="table-label" class="block text-gray-700 font-semibold mb-2"></label>
                    <select id="table-number" name="table-number" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="" disabled selected>--</option>
                        <!-- Options will be generated by JavaScript -->
                    </select>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-6 text-left" id="order-summary-content">
                    <div id="order-summary" class="text-sm text-gray-600 space-y-2">
                        <!-- Order summary will be displayed here -->
                    </div>
                    <div class="border-t pt-2 mt-2" id="order-total-container">
                        <div class="flex justify-between font-semibold">
                            <span id="modal-total-text"></span>
                            <span id="modal-total" class="text-green-600"></span>
                        </div>
                    </div>
                </div>
                
                <!-- QR Code container -->
                <div id="qrcode-container" class="mt-4 flex justify-center hidden"></div>
                
                <div class="flex space-x-3" id="modal-actions">
                    <button id="modal-edit-btn" onclick="closeOrderModal()" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                    </button>
                    <button id="modal-confirm-btn" onclick="confirmOrder()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============== CONFIGURATION DU MENU ==============
        // Modifiez ces objets pour changer le contenu du menu et les traductions.

        const menuData = {
            restaurantName: "Plumeria Restaurant",
            currency: "Ar",
            categories: [
                {
                    id: 'entrees',
                    colorClass: 'category-entrees',
                    imageUrl: 'https://placehold.co/600x400/FAF8ED/527A50?text=Entrées',
                    items: [
                        { id: 'veloute_de_potiron', price: 22000 },
                        { id: 'potage_de_carotte', price: 22000 },
                        { id: 'creme_de_tarot', price: 22000 },
                        { id: 'nems_salade', price: 22000 },
                        { id: 'salade_chevre', price: 25000 },
                        { id: 'crabe_farci', price: 26000 },
                        { id: 'calamars_croustillants', price: 25000 },
                        { id: 'croquette_de_camembert', price: 26000 },
                        { id: 'taboule', price: 18000 },
                        { id: 'salade_cesar', price: 22000 }
                    ]
                },
                {
                    id: 'plats',
                    colorClass: 'category-plats',
                    imageUrl: 'https://placehold.co/600x400/FFEBEB/EF4444?text=Plats',
                    items: [
                        { id: 'porc_grillee', price: 30000 },
                        { id: 'porc_moutarde', price: 28000 },
                        { id: 'escalope_milanaise', price: 32000 },
                        { id: 'brochettes_de_poulet', price: 30000 },
                        { id: 'emince_poulet_tikka', price: 30000 },
                        { id: 'emince_poulet_champignons', price: 32000 },
                        { id: 'roule_de_volaille', price: 32000 },
                        { id: 'cuisse_de_canard', price: 36000 },
                        { id: 'magret_de_canard', price: 42000 },
                        { id: 'magret_de_canard_farci', price: 32000 },
                        { id: 'cocotte_d_agneau', price: 32000 }
                    ],
                    addOns: {
                        id: 'accompagnements',
                        items: [
                            { id: 'riz_blanc', price: 7000 },
                            { id: 'legumes_sautes', price: 7000 },
                            { id: 'pomme_sautee', price: 7000 },
                            { id: 'spaghetti', price: 7000 }
                        ]
                    }
                },
                {
                    id: 'plats_malagasy',
                    colorClass: 'category-plats-malagasy',
                    imageUrl: 'https://placehold.co/600x400/98d298/059669?text=Malagasy',
                    items: [
                        { id: 'tilapia_endasina', price: 28000 },
                        { id: 'akoho_gasy', price: 25000 },
                        { id: 'romazava_royale', price: 29000 },
                        { id: 'henomby_ritra', price: 27000 }
                    ]
                },
                {
                    id: 'desserts',
                    colorClass: 'category-desserts',
                    imageUrl: 'https://placehold.co/600x400/E5E8FF/8B5CF6?text=Desserts',
                    items: [
                        { id: 'assiette_fruits', price: 15000 },
                        { id: 'affogato', price: 14000 },
                        { id: 'fruits_flambes', price: 16000 },
                        { id: 'choux_craquelin', price: 15000 },
                        { id: 'panna_cotta', price: 15000 },
                        { id: 'fondant_chocolat', price: 17000 },
                        { id: 'coupe_glacee_caramel', price: 15000 },
                        { id: 'coupe_glacee_fruits', price: 16000 },
                        { id: 'nougat_glace', price: 15000 },
                        { id: 'coupe_glace', price: 15000 }
                    ]
                }
            ]
        };

        const translations = {
            fr: {
                restaurantSlogan: "Composez votre menu idéal",
                cartTitle: 'Votre Commande',
                cartPlaceholder: 'Sélectionnez vos plats pour commencer',
                totalText: 'Total :',
                orderBtn: 'Passer la commande',
                clearCartBtn: 'Vider le panier',
                tableLabel: 'Numéro de table',
                modalTitleSummary: 'Résumé de votre commande',
                modalMessageSummary: 'Vérifiez votre commande et votre numéro de table avant de la finaliser.',
                modalEditBtn: 'Modifier',
                modalConfirmBtn: 'Confirmer la commande',
                modalTitleConfirmed: 'Commande Confirmée !',
                modalMessageConfirmed: 'Veuillez scanner le QR code pour valider votre commande.',
                modalCloseBtn: 'Fermer',
                categories: {
                    entrees: { name: '🥗 Entrées', description: 'Pour bien commencer votre repas' },
                    plats: { name: '🥩 Plats', description: 'Une sélection de plats savoureux' },
                    plats_malagasy: { name: '🍚 Plats Malagasy', description: 'Découvrez les saveurs de la cuisine malgache' },
                    desserts: { name: '🍰 Desserts', description: 'La touche sucrée de votre repas' }
                },
                items: {
                    veloute_de_potiron: { name: 'Velouté de potiron', description: 'fromage, crouton à l\'ail' },
                    potage_de_carotte: { name: 'Potage de carotte au fromage', description: '' },
                    creme_de_tarot: { name: 'Crème de tarot', description: '' },
                    nems_salade: { name: 'Nems salade verte', description: 'sauce arachide' },
                    salade_chevre: { name: 'Salade de chèvre', description: 'fines herbes, salade verte' },
                    crabe_farci: { name: 'Crabe farci', description: '' },
                    calamars_croustillants: { name: 'Calamars croustillants', description: 'salade verte' },
                    croquette_de_camembert: { name: 'Croquette de camembert', description: '' },
                    taboule: { name: 'Taboulé', description: '' },
                    salade_cesar: { name: 'Salade César', description: '' },
                    porc_grillee: { name: 'Porc grillée à la sicilienne', description: '' },
                    porc_moutarde: { name: 'Porc à la moutarde', description: '' },
                    escalope_milanaise: { name: 'Escalope milanaise', description: '' },
                    brochettes_de_poulet: { name: 'Brochettes de poulet', description: '' },
                    emince_poulet_tikka: { name: 'Emincé de poulet tikka massala', description: '' },
                    emince_poulet_champignons: { name: 'Emincé de poulet aux champignons', description: '' },
                    roule_de_volaille: { name: 'Roulé de volaille au lard à la provençale', description: '' },
                    cuisse_de_canard: { name: 'Cuisse de canard confite', description: 'sauce au choix' },
                    magret_de_canard: { name: 'Magret de canard', description: 'sauce au choix' },
                    magret_de_canard_farci: { name: 'Magret de canard farci', description: 'aux champignons, sauce poivre' },
                    cocotte_d_agneau: { name: 'Cocotte d\'agneau', description: '' },
                    tilapia_endasina: { name: 'Tilapia endasina sy saosy voatabia', description: 'Tilapia entier frit, sauce tomate' },
                    akoho_gasy: { name: 'Akoho Gasy rony', description: 'Bouillon de poulet fermier au gingembre' },
                    romazava_royale: { name: 'Romazava Royale', description: 'ragout de brèdes, viandes mixtes' },
                    henomby_ritra: { name: 'Hen\'omby ritra Royale', description: 'bœuf braisé' },
                    assiette_fruits: { name: 'Assiette ou Salade de fruits', description: '' },
                    affogato: { name: 'Affogato', description: '' },
                    fruits_flambes: { name: 'Fruits flambés', description: '' },
                    choux_craquelin: { name: 'Choux craquelin', description: 'glacé à la crème diplomate' },
                    panna_cotta: { name: 'Panna cotta', description: 'vanille, coulis' },
                    fondant_chocolat: { name: 'Fondant au chocolat', description: 'glace vanille (15 min)' },
                    coupe_glacee_caramel: { name: 'Coupe glacée au caramel', description: '' },
                    coupe_glacee_fruits: { name: 'Coupe glacée aux fruits', description: '' },
                    nougat_glace: { name: 'Nougat glacé', description: '' },
                    coupe_glace: { name: 'Coupe de Glace', description: '' }
                },
                addOns: {
                    accompagnements: {
                        title: 'Ajoutez un accompagnement :',
                        items: {
                            riz_blanc: { name: 'Riz blanc' },
                            legumes_sautes: { name: 'Légumes sautés' },
                            pomme_sautee: { name: 'Pomme sautée' },
                            spaghetti: { name: 'Spaghetti' }
                        }
                    }
                }
            },
            en: {
                restaurantSlogan: "Compose your ideal menu",
                cartTitle: 'Your Order',
                cartPlaceholder: 'Select your dishes to start',
                totalText: 'Total:',
                orderBtn: 'Place Order',
                clearCartBtn: 'Clear Cart',
                tableLabel: 'Table Number',
                modalTitleSummary: 'Order Summary',
                modalMessageSummary: 'Please check your order and table number before finalizing.',
                modalEditBtn: 'Edit',
                modalConfirmBtn: 'Confirm Order',
                modalTitleConfirmed: 'Order Confirmed!',
                modalMessageConfirmed: 'Please scan the QR code to validate your order.',
                modalCloseBtn: 'Close',
                categories: {
                    entrees: { name: '🥗 Appetizers', description: 'To start your meal well' },
                    plats: { name: '🥩 Main Dishes', description: 'A selection of savory main dishes' },
                    plats_malagasy: { name: '🍚 Malagasy Dishes', description: 'Discover the flavors of Malagasy cuisine' },
                    desserts: { name: '🍰 Desserts', description: 'The sweet touch to your meal' }
                },
                items: {
                    veloute_de_potiron: { name: 'pumpkin cream', description: 'cheese, garlic crouton' },
                    potage_de_carotte: { name: 'Carrot and Cheese Soup', description: '' },
                    creme_de_tarot: { name: 'Tarot Cream', description: '' },
                    nems_salade: { name: 'Green salad spring rolls', description: 'peanut sauce' },
                    salade_chevre: { name: 'Goat cheese salad', description: 'herbs, green salad' },
                    crabe_farci: { name: 'Stuffed crab', description: '' },
                    calamars_croustillants: { name: 'Crispy calamari', description: 'green salad' },
                    croquette_de_camembert: { name: 'Camembert croquette', description: '' },
                    taboule: { name: 'Taboulé', description: '' },
                    salade_cesar: { name: 'Caesar Salad', description: '' },
                    porc_grillee: { name: 'Sicilian Grilled Pork', description: '' },
                    porc_moutarde: { name: 'Pork with mustard', description: '' },
                    escalope_milanaise: { name: 'Milanese escalope', description: '' },
                    brochettes_de_poulet: { name: 'Chicken skewers', description: '' },
                    emince_poulet_tikka: { name: 'Sliced ​​chicken tikka masala', description: '' },
                    emince_poulet_champignons: { name: 'Sliced ​​chicken with mushrooms', description: '' },
                    roule_de_volaille: { name: 'Provençal-style poultry roll with bacon', description: '' },
                    cuisse_de_canard: { name: 'Confit duck leg', description: 'choice of sauce' },
                    magret_de_canard: { name: 'Duck breast', description: 'choice of sauce' },
                    magret_de_canard_farci: { name: 'Stuffed duck breast', description: 'with mushrooms, pepper sauce' },
                    cocotte_d_agneau: { name: 'Lamb casserole', description: '' },
                    tilapia_endasina: { name: 'Tilapia endasina sy saosy voatabia', description: 'Whole fried tilapia, tomato sauce' },
                    akoho_gasy: { name: 'Akoho Gasy rony', description: 'Broth of free-range chicken with ginger' },
                    romazava_royale: { name: 'Romazava Royale', description: 'ragout of greens, mixed meats' },
                    henomby_ritra: { name: 'Hen\'omby ritra Royale', description: 'braised beef' },
                    assiette_fruits: { name: 'Fruit plate or salad', description: '' },
                    affogato: { name: 'Affogato', description: '' },
                    fruits_flambes: { name: 'Flambéed fruits', description: '' },
                    choux_craquelin: { name: 'Choux craquelin', description: 'glazed with diplomat cream' },
                    panna_cotta: { name: 'Panna cotta', description: 'vanilla, coulis' },
                    fondant_chocolat: { name: 'Chocolate fondant', description: 'vanilla ice cream (15 min)' },
                    coupe_glacee_caramel: { name: 'Caramel Ice Cream Sundae', description: '' },
                    coupe_glacee_fruits: { name: 'Fruit ice cream sundae', description: '' },
                    nougat_glace: { name: 'Frozen nougat', description: '' },
                    coupe_glace: { name: 'Ice Cream Sundae', description: '' }
                },
                addOns: {
                    accompagnements: {
                        title: 'Add a side dish:',
                        items: {
                            riz_blanc: { name: 'White rice' },
                            legumes_sautes: { name: 'Sautéed vegetables' },
                            pomme_sautee: { name: 'Sautéed potatoes' },
                            spaghetti: { name: 'Spaghetti' }
                        }
                    }
                }
            }
        };

        let currentLang = 'fr';
        let cart = {};
        let activeDishSelection = null;

        function getTranslation(path, lang = currentLang) {
            const keys = path.split('.');
            let value = translations[lang];
            for (let key of keys) {
                if (value === undefined) return '';
                value = value[key];
            }
            return value || '';
        }

        function toggleLanguage() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            const langBtn = document.getElementById('lang-btn');
            if (langBtn) {
                langBtn.textContent = currentLang.toUpperCase();
            }
            renderAllContent();
        }

        function renderAllContent() {
            renderMenu();
            updateCart();
            updateStaticText();
            renderTableOptions();
        }

        function updateStaticText() {
            const lang = translations[currentLang];
            const elements = {
                'restaurant-slogan': lang.restaurantSlogan,
                'cart-title': lang.cartTitle,
                'cart-placeholder': lang.cartPlaceholder,
                'total-text': lang.totalText,
                'order-btn': lang.orderBtn,
                'clear-cart-btn': lang.clearCartBtn,
                'table-label': lang.tableLabel
            };

            for (const id in elements) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = elements[id];
                }
            }
        }

        function renderTableOptions() {
            const selectElement = document.getElementById('table-number');
            if (!selectElement) return;

            selectElement.innerHTML = `<option value="" disabled selected>${getTranslation('tableLabel')}</option>`;
            for (let i = 1; i <= 10; i++) {
                selectElement.innerHTML += `<option value="${i}">Table ${i}</option>`;
            }
        }
        
        function renderMenu() {
            const menuContainer = document.getElementById('menu-container');
            const currency = menuData.currency;
            const restaurantNameElement = document.getElementById('restaurant-name');
            if (restaurantNameElement) {
                restaurantNameElement.textContent = menuData.restaurantName;
            }

            let menuHTML = '';

            menuData.categories.forEach(category => {
                const categoryTranslation = getTranslation(`categories.${category.id}`);
                menuHTML += `
                    <section class="mb-12">
                        <div class="${category.colorClass} rounded-xl p-6 mb-6 shadow-lg flex items-center space-x-6">
                            <img src="${category.imageUrl}" alt="Image de la catégorie ${categoryTranslation.name}" class="w-24 h-24 object-cover rounded-lg shadow-md">
                            <div>
                                <h2 class="font-display text-2xl font-semibold text-gray-800 mb-2">${categoryTranslation.name}</h2>
                                <p class="text-gray-700 font-light">${categoryTranslation.description}</p>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                `;

                category.items.forEach(item => {
                    const itemTranslation = getTranslation(`items.${item.id}`);
                    menuHTML += `
                        <div class="item-card bg-white rounded-lg p-5 cursor-pointer shadow-sm" onclick="selectItem(this, '${category.id}', '${item.id}', ${item.price})">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="font-semibold text-gray-900">${itemTranslation.name}</h3>
                                <span class="text-amber-600 font-semibold">${(item.price).toLocaleString()} ${currency}</span>
                            </div>
                            <p class="text-gray-600 text-sm">${itemTranslation.description}</p>
                        </div>
                    `;
                });

                menuHTML += `</div>`;

                if (category.addOns) {
                    const addOnTranslation = getTranslation(`addOns.${category.addOns.id}`);
                    menuHTML += `
                        <div id="addons-${category.id}" class="bg-red-50 rounded-lg p-4 mt-6 hidden">
                            <h4 class="font-semibold text-gray-800 mb-3">${addOnTranslation.title}</h4>
                            <div class="flex flex-wrap gap-2">
                    `;
                    category.addOns.items.forEach(addOn => {
                        const addOnItemTranslation = getTranslation(`addOns.${category.addOns.id}.items.${addOn.id}`);
                        menuHTML += `
                            <button class="add-on-chip bg-white border border-red-200 px-3 py-2 rounded-full text-sm font-medium text-gray-700" onclick="toggleSideDish(this, '${addOn.id}', ${addOn.price})">
                                ${addOnItemTranslation.name} (+${(addOn.price).toLocaleString()} ${currency})
                            </button>
                        `;
                    });
                    menuHTML += `</div></div>`;
                }

                menuHTML += `</section>`;
            });

            if (menuContainer) {
                menuContainer.innerHTML = menuHTML;
            }
        }

        function selectItem(element, categoryId, itemId, price) {
            document.querySelectorAll('[id^="addons-"]').forEach(el => el.classList.add('hidden'));
            const categoryCards = element.closest('section').querySelectorAll('.item-card');
            categoryCards.forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');

            const itemName = getTranslation(`items.${itemId}.name`);
            const item = { id: itemId, name: itemName, price: price, category: categoryId, quantity: 1 };
            const categoryData = menuData.categories.find(c => c.id === categoryId);

            if (categoryData && categoryData.addOns) {
                const addons = document.getElementById(`addons-${categoryId}`);
                if (addons) {
                    addons.classList.remove('hidden');
                }
                activeDishSelection = item;
                
                const activeAddons = document.getElementById(`addons-${categoryId}`);
                if (activeAddons) {
                     activeAddons.querySelectorAll('.add-on-chip').forEach(btn => btn.classList.remove('selected'));
                }
                
                // *** FIX START ***
                // Corrected logic: add item or increment quantity, don't delete others.
                if (cart[itemId]) {
                    cart[itemId].quantity++;
                } else {
                    cart[itemId] = item;
                }
                // *** FIX END ***

            } else {
                activeDishSelection = null;
                if (cart[itemId]) {
                    cart[itemId].quantity++;
                } else {
                    cart[itemId] = item;
                }
            }
            updateCart();
        }
        
        function toggleSideDish(button, addOnId, addOnPrice) {
            if (!activeDishSelection) return;

            const baseDishId = activeDishSelection.id;
            const finalId = `${baseDishId}_${addOnId}`;

            delete cart[baseDishId];
            Object.keys(cart).forEach(key => {
                if (key.startsWith(baseDishId + '_')) delete cart[key];
            });

            const allAddOnButtons = button.closest('[id^="addons-"]').querySelectorAll('.add-on-chip');
            const addOnName = getTranslation(`addOns.accompagnements.items.${addOnId}.name`);

            if (button.classList.contains('selected')) {
                button.classList.remove('selected');
                cart[baseDishId] = activeDishSelection;
            } else {
                allAddOnButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                
                cart[finalId] = {
                    id: finalId,
                    name: `${activeDishSelection.name} + ${addOnName}`,
                    price: activeDishSelection.price + addOnPrice,
                    category: activeDishSelection.category,
                    quantity: 1
                };
            }
            updateCart();
        }

        function updateQuantity(itemId, change) {
            if (cart[itemId]) {
                cart[itemId].quantity += change;
                if (cart[itemId].quantity <= 0) {
                    delete cart[itemId];
                }
            }
            updateCart();
        }

        function removeFromCart(itemId) {
             if (cart[itemId]) {
                delete cart[itemId];
            }
            updateCart();
        }

        function updateCart() {
            const cartItemsContainer = document.getElementById('cart-items');
            const totalPriceElement = document.getElementById('total-price');
            const cartActionsElement = document.getElementById('cart-actions');
            const currency = menuData.currency;
            
            const cartArray = Object.values(cart);

            if (!cartItemsContainer || !totalPriceElement || !cartActionsElement) return;

            if (cartArray.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div id="cart-placeholder" class="text-gray-500 text-center py-8 italic">
                        ${getTranslation('cartPlaceholder')}
                    </div>
                `;
                cartActionsElement.classList.add('hidden');
            } else {
                cartItemsContainer.innerHTML = cartArray.map(item => `
                    <div class="cart-item bg-gray-50 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-gray-900 text-sm">${item.name}</h4>
                            <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700 text-sm font-bold">✕</button>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-2">
                                <button onclick="updateQuantity('${item.id}', -1)" class="w-6 h-6 bg-gray-200 rounded-full text-sm font-bold hover:bg-gray-300">-</button>
                                <span class="text-sm font-medium">${item.quantity}</span>
                                <button onclick="updateQuantity('${item.id}', 1)" class="w-6 h-6 bg-gray-200 rounded-full text-sm font-bold hover:bg-gray-300">+</button>
                            </div>
                            <span class="font-semibold text-green-600">${(item.price * item.quantity).toLocaleString()} ${currency}</span>
                        </div>
                    </div>
                `).join('');
                cartActionsElement.classList.remove('hidden');
            }
            
            const total = cartArray.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalPriceElement.textContent = `${total.toLocaleString()} ${currency}`;
        }

        function clearCart() {
            cart = {};
            activeDishSelection = null;
            
            document.querySelectorAll('.item-card.selected').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.add-on-chip.selected').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('[id^="addons-"]').forEach(el => el.classList.add('hidden'));
            
            updateCart();
        }

        function showOrderSummary() {
            if (Object.keys(cart).length === 0) return;

            const modal = document.getElementById('order-modal');
            const modalContent = modal.querySelector('div > div');
            
            const modalTitle = document.getElementById('modal-title');
            if (modalTitle) modalTitle.textContent = getTranslation('modalTitleSummary');
            
            const modalMessage = document.getElementById('modal-message');
            if (modalMessage) modalMessage.textContent = getTranslation('modalMessageSummary');

            const orderSummaryContent = document.getElementById('order-summary-content');
            if (orderSummaryContent) orderSummaryContent.classList.remove('hidden');

            const tableSelectContainer = document.getElementById('table-select-container');
            if (tableSelectContainer) tableSelectContainer.classList.remove('hidden');

            const qrcodeContainer = document.getElementById('qrcode-container');
            if (qrcodeContainer) qrcodeContainer.classList.add('hidden');
            
            const modalActions = document.getElementById('modal-actions');
            if (modalActions) {
                modalActions.innerHTML = `
                    <button onclick="closeOrderModal()" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        ${getTranslation('modalEditBtn')}
                    </button>
                    <button onclick="confirmOrder()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors">
                        ${getTranslation('modalConfirmBtn')}
                    </button>
                `;
            }

            const orderSummaryContainer = document.getElementById('order-summary');
            const modalTotal = document.getElementById('modal-total');
            const modalTotalText = document.getElementById('modal-total-text');
            const cartArray = Object.values(cart);
            const currency = menuData.currency;
            const total = cartArray.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (modalTotalText) modalTotalText.textContent = getTranslation('totalText');

            if (orderSummaryContainer) {
                orderSummaryContainer.innerHTML = cartArray.map(item => `
                    <div class="flex justify-between py-1">
                        <span>${item.quantity}x ${item.name}</span>
                        <span class="font-medium">${(item.price * item.quantity).toLocaleString()} ${currency}</span>
                    </div>
                `).join('');
            }
            
            if (modalTotal) modalTotal.textContent = `${total.toLocaleString()} ${currency}`;

            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
            if (modalContent) {
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }
        }

        function closeOrderModal() {
            const modal = document.getElementById('order-modal');
            const modalContent = modal.querySelector('div > div');
            if (modalContent) {
                 modalContent.classList.add('scale-95', 'opacity-0');
            }
            if (modal) {
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }, 300);
            }
        }

        function confirmOrder() {
            const tableNumberElement = document.getElementById('table-number');
            const tableNumber = tableNumberElement ? tableNumberElement.value : null;

            if (!tableNumber) {
                const modal = document.getElementById('order-modal');
                const modalMessage = document.getElementById('modal-message');
                if (modalMessage) {
                    modalMessage.textContent = 'Veuillez sélectionner votre numéro de table pour confirmer la commande.';
                }
                return;
            }

            const modalTitle = document.getElementById('modal-title');
            if (modalTitle) modalTitle.textContent = getTranslation('modalTitleConfirmed');

            const modalMessage = document.getElementById('modal-message');
            if (modalMessage) modalMessage.textContent = getTranslation('modalMessageConfirmed');
            
            const orderSummaryContent = document.getElementById('order-summary-content');
            if (orderSummaryContent) orderSummaryContent.classList.add('hidden');

            const tableSelectContainer = document.getElementById('table-select-container');
            if (tableSelectContainer) tableSelectContainer.classList.add('hidden');
            
            const qrcodeContainer = document.getElementById('qrcode-container');
            if (qrcodeContainer) qrcodeContainer.classList.remove('hidden');
            
            generateQRCode(tableNumber);
            
            const modalActions = document.getElementById('modal-actions');
            if (modalActions) {
                modalActions.innerHTML = `
                    <button onclick="closeOrderModal(); clearCart();" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors">
                        ${getTranslation('modalCloseBtn')}
                    </button>
                `;
            }
        }
        
        function generateQRCode(tableNumber) {
            const qrcodeContainer = document.getElementById('qrcode-container');
            if (!qrcodeContainer) return;
            
            // *** FIX START ***
            // Using a more compact data structure (array of arrays) to save space.
            const compactOrder = {
                t: tableNumber,
                i: Object.values(cart).map(item => [item.id, item.quantity])
            };
            // *** FIX END ***

            const qrData = JSON.stringify(compactOrder);
            
            qrcodeContainer.innerHTML = '';
            
            new QRCode(qrcodeContainer, {
                text: qrData,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                // *** FIX START ***
                // Lowering error correction level to increase data capacity.
                correctLevel : QRCode.CorrectLevel.L
                // *** FIX END ***
            });
        }

        window.onload = renderAllContent;
    </script>
</body>
</html>
